name: Flutter CI, Tests & Builds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1) Analyze & unit/widget tests
  analyze-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: flutter analyze
      - run: flutter test --coverage

  # 2) Android emulator + integration tests
   android-emulator:
    name: 🤖 android-emulator
    needs: analyze‑and‑test
    runs‑on: ubuntu‑latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: |
          # install a system image & start emulator
          sudo apt-get update && sudo apt-get install -y libglu1-mesa
          echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86"
          emulator -avd test -no-window -no-audio &
          flutter emulators --launch test
      - run: flutter drive --driver=test_driver/integration_test.dart --target=integration_test/app_test.dart

  ios-simulator:
    name: 🍎 ios-simulator
    needs: analyze‑and‑test
    runs‑on: macos‑latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: |
          # boot a simulator
          xcrun simctl boot "iPhone 12"
          flutter drive --driver=test_driver/integration_test.dart --target=integration_test/app_test.dart

  build-android:
    name: 📦 build‑android
    needs: analyze‑and‑test
    runs‑on: ubuntu‑latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: flutter build apk --release
      - uses: actions/upload-artifact@v3
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  build-ios-simulator:
    name: 📱 build‑ios‑simulator
    needs: analyze‑and‑test
    runs‑on: macos‑latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: flutter build ios --simulator --no-codesign
      - uses: actions/upload-artifact@v3
        with:
          name: ios-simulator-app
          path: build/ios/iphonesimulator/Runner.app
